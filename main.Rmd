---
title: "Read Data"
author: ''
date: "11/23/2021"
output:
  pdf_document: default
  html_document: default
---
```{r}
library(foreign)
library(tidyverse)
library(e1071)
library(tree)
library(gbm)
library(randomForest)
library(caret)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(patchwork)
library(UBL)
sesame <- read.dta("sesame.dta")
sesame <- sesame %>%
  mutate(site=factor(site)) %>%
  mutate(bodyDiff = postbody - prebody,
         letDiff = postlet - prelet,
         formDiff = postform - preform,
         numbDiff = postnumb - prenumb,
         relatDiff = postrelat - prerelat,
         clasfDiff = postclasf - preclasf)
sesame.sd <- sesame%>%
  mutate(sd_pBod = scale(prebody, center = TRUE, scale = TRUE),
         sd_plet = scale(prelet, center = TRUE, scale = TRUE),
         sd_pform = scale(preform, center = TRUE, scale = TRUE),
         sd_pnumb = scale(prenumb, center = TRUE, scale = TRUE),
         sd_prelat = scale(prerelat, center = TRUE, scale = TRUE),
         sd_pclasf = scale(preclasf, center = TRUE, scale = TRUE),
         sd_peabody = scale(peabody, center = TRUE, scale = TRUE), 
         sd_age = scale(age, center =TRUE, scale = TRUE),
         male=if_else(sex==1, 1, 0),
         female=if_else(sex==2, 1, 0))
```

## Exploratory Data Analysis

```{r viewdata}
head(sesame)
```

### Variables:

The ID refers to a subject's identification number. The site refers to the age and background information of the child. A site value of 1 indicates a 3-5 year old disadvantaged child from the inner city. A site value of 2 represents a 4 year old advantaged child from the suburbs. A value of 3 represents an advantaged rural child. A site value of 4 indicates a disadvantaged rural child. Lastly, a value of 5 represents a disadvantaged Spanish speaking child. For the sex, a value of 1 indicates male, and a value of 2 indicates female. The age category is the child's age in months. The viewcat column is the frequency of viewing Sesame Street (1 = rarely, 2 = once/twice per week, 3 = 3-5 times a week, 4 = more than 5 times per week). The setting is where Sesame Street was viewed; a value of 1 indicates home and a value of 2 indicates school. The viewenc column refers to if the child was encouraged to watch or not (1 = child not encouraged, 2 = child encouraged). Encour is the same variable but with values 0 and 1, respectively. Regular is an indicator variable representing if a child is a regular viewer (0 = rarely watched, 1 = watched once per week or greater). 

The prebody, prelet, preform, prenumb, prerelat, and preclasf columns all decribe pretest scores on varying types of assessments (body parts, letters, forms, numbers, relational terms, and classification skills, respectively). The columns labelled postbody, postlet, postform, postnumb, postrelat, and postclasf are the children's respective posttest scores. Above, we created the following variables - bodydiff, letDiff, formDiff, numbDiff, relatDiff, clasfDiff - to represent the difference in posttest scores and pretest scores for each child. Lastly, peabody represents a score of "mental age" for vocabulary maturity from the Peabody Picture Vocabulary Test.

Our main focus will be on the new variables we created (bodyDiff, letDiff, formDiff, numbDiff, relatDiff, clasfDiff) and variables related to how often the children watch Sesame Street (namely, viewcat and regular). Lastly, we will look into the backgrounds of the children, including site, sex, and age.


### Distributions:

For the purposes of our analysis, we will first look at the distributions of bodyDiff, letDiff, formDiff, numbDiff, relatDiff, and clasfDiff.

```{r visualizetestscoresdiff, message=FALSE}

#want to visualize distributions of bodyDiff, letDiff, formDiff, numbDiff, relatDiff, clasfDiff

bodyDiffplot <- ggplot(sesame, aes(x = bodyDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of bodyDiff", x = "Post - Pre on Body Parts", y = "Count") +
  theme_minimal()

letDiffplot <- ggplot(sesame, aes(x = letDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of letDiff", x = "Post - Pre on Letters", y = "Count") +
  theme_minimal()

formDiffplot <- ggplot(sesame, aes(x = formDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of formDiff", x = "Post - Pre on Forms", y = "Count") +
  theme_minimal()

numbDiffplot <- ggplot(sesame, aes(x = numbDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of numbDiff", x = "Post - Pre on Numbers", y = "Count") +
  theme_minimal()

relatDiffplot <- ggplot(sesame, aes(x = relatDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of relatDiff", x = "Post - Pre Relational Terms", y = "Count") +
  theme_minimal()

clasfDiffplot <- ggplot(sesame, aes(x = clasfDiff)) + 
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of clasfDiff", x = "Post - Pre on Classif. Skills", y = "Count") +
  theme_minimal()


bodyDiffplot + letDiffplot + formDiffplot + numbDiffplot + relatDiffplot + clasfDiffplot

```

The six variables above were calculated by subtracting pre-test scores from post-test scores, so they are all numerical. The distributions of these six variables (bodyDiff, letDiff, formDiff, numbDiff, relatDiff, and clasfDiff) all appear to be roughly normal and unimodal. BodyDiff, letDiff, formDiff, relatDiff, and classDiff do not appear to have any obvious extreme outliers. Numbdiff, however, seems to be slightly left-skewed with outliers to the left -20. All of the six variables appear to have centers between 2 and 4. 



We will now examine the distrubtions of the variables related to how often children watch Sesame Street (namely, viewcat and regular).

```{r visualizingwatchingbehavior, message=FALSE}

# want to visualize distributions of viewcat and regular

viewcatplot <- ggplot(sesame, aes(x = factor(viewcat))) +
  geom_bar(fill = "lightblue") +
  labs(title = "Distribution of Viewcat", x = "Frequency of viewing Sesame Street", y = "Count") +
  scale_x_discrete("Frequency of Viewing Sesame Street", labels=c("rarely", "1-2 pw", "3-5 pw", ">5 pw")) +
  theme_minimal() +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")


regularplot <- ggplot(sesame, aes(x = factor(regular))) +
  geom_bar(fill = "lightblue") +
  labs(title = "Distribution of Regular", y = "Count") +
  scale_x_discrete(labels=c("rarely watched", "watched >= 1 per week")) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")

viewcatplot + regularplot

```

Both of these variables are categorical. On the left, viewcat appears to have a roughly uniform distribution, with "rarely" having the least amount of children and 3-5 times per week having the most (the range is only 10 children, so all of the bars are relatively close in height). For the variable regular, the category "watched once per week or greater" has far more observations than "rarely watched." The former category has more than triple the amount of the latter. We will be aware of this disparity in our analysis and continue with caution towards potential bias.


Lastly, we want to examine the distributions of site, sex, and age, all variables that relate to a child's background.

```{r visualizingbackground, message=FALSE}

# want to visualize distributions of site, sex, and age

siteplot <- ggplot(sesame, aes(x = factor(site))) +
  geom_bar(fill = "lightblue") +
  labs(title = "Distribution of Site", y = "Count") +
  scale_x_discrete(labels=c("3-5, disadv., inner city", "4, adv., suburb", "adv., rural", "disadv., rural", "disadv., Spanish")) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")

sexplot <- ggplot(sesame, aes(x = factor(sex))) +
  geom_bar(fill = "lightblue") +
  labs(title = "Distribution of Sex", y = "Count") +
  scale_x_discrete(labels=c("Male", "Female")) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")

ageplot <- ggplot(sesame, aes(x = age)) +
  geom_histogram(fill = "lightblue") +
  labs(title = "Distribution of Age", x = "Age in Months", y = "Count") +
  theme_minimal()

siteplot / (sexplot + ageplot)

```

Distribution of Site and Sex are both categorical variables. Distribution of Site has four categories with roughly the same amount of children (ranging from 43 to 64), but one category with far fewer observations (disadvantaged Spanish-speaking). This cateogry has less than half of the observations as the next smallest category, which is a relatively large disparity. We will continue our analysis with caution towards this bias in the data. The distribution of sex is very even - the male category has 115 observations, while the female category has 125 observations. 
Age is a numerical variable that appears to be normal and bimodal, with two peaks around 50 and 56. There do not appear to be any extreme outliers in the distribution of age.

## Q.1 Prediction Question: Can we use linear regression to predict the change in a child's test scores that occur after watching Sesame street (or in some instances, not watching Seasame street)?

Here, I am fitting 7 linear regression models. The first 6 models predict a different difference in test score while the last model predicts the total difference in test scores. 

```{r factor-categoricals}

sesame$site <- as.factor(sesame$site)
sesame$sex <- as.factor(sesame$sex)
sesame$viewcat <- as.factor(sesame$viewcat)
sesame$setting <- as.factor(sesame$setting)
sesame$viewenc <- as.factor(sesame$viewenc)

```

```{r create-new-variable}

sesame <- sesame %>%
  mutate(totDiff = bodyDiff + letDiff + formDiff + numbDiff + relatDiff + clasfDiff)

```

```{r}

lin.mod1 <- lm(bodyDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod1)

# training MSE
mean(summary(lin.mod1)$residuals^2)

# cross validation metrics
m1.ctrl <- trainControl(method = "cv", number = 5)
m1.cv <- train(bodyDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m1.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m1.cv

AIC(lin.mod1)

lin.mod1.full <- lm(bodyDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod1.full)

```

```{r LASSO}

# Split data between x and y
x <- model.matrix(bodyDiff ~ site + sex + age + viewcat + setting + viewenc,sesame)[,-1]
y <- sesame$bodyDiff

# set seed
set.seed(1)

# cross validation for lambda
# I couldn't run cv.glmnet, so I commented it out, make sure to uncomment these calls.
# cv.out <- cv.glmnet(x, y, alpha = 1) # setting alpha = 1 indicates lasso regression

# optimal lambda value
#best.lam <- cv.out$lambda.min

# lasso regression model with optimal lambda
#las.mod <- glmnet(x, y, alpha = 1, lambda = best.lam)

```

```{r}

lin.mod2 <- lm(letDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod2)

# training MSE
mean(summary(lin.mod2)$residuals^2)

# cross validation metrics
m2.ctrl <- trainControl(method = "cv", number = 5)
m2.cv <- train(letDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m2.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m2.cv

AIC(lin.mod2)

lin.mod2.full <- lm(letDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod2.full)

summary(lin.mod2)

```

```{r}

lin.mod3 <- lm(formDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod3)

# training MSE
mean(summary(lin.mod3)$residuals^2)

# cross validation metrics
m3.ctrl <- trainControl(method = "cv", number = 5)
m3.cv <- train(formDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m3.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m3.cv

AIC(lin.mod3)

lin.mod3.full <- lm(formDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod3.full)

```

```{r}

lin.mod4 <- lm(numbDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod4)

# training MSE
mean(summary(lin.mod4)$residuals^2)

# cross validation metrics
m4.ctrl <- trainControl(method = "cv", number = 5)
m4.cv <- train(numbDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m4.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m4.cv

AIC(lin.mod4)

lin.mod4.full <- lm(numbDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod4.full)

```

```{r}

lin.mod5 <- lm(relatDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod5)

# training MSE
mean(summary(lin.mod5)$residuals^2)

# cross validation metrics
m5.ctrl <- trainControl(method = "cv", number = 5)
m5.cv <- train(relatDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m5.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m5.cv

AIC(lin.mod5)

lin.mod5.full <- lm(relatDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod5.full)

```

```{r}

lin.mod6 <- lm(clasfDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod6)

# training MSE
mean(summary(lin.mod6)$residuals^2)

# cross validation metrics
m6.ctrl <- trainControl(method = "cv", number = 5)
m6.cv <- train(clasfDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m6.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m6.cv

AIC(lin.mod6)

lin.mod6.full <- lm(clasfDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod6.full)

```

```{r}

lin.mod7 <- lm(totDiff ~ site + sex + age + viewcat + setting + viewenc, data = sesame)
summary(lin.mod7)

# training MSE
mean(summary(lin.mod7)$residuals^2)

# cross validation metrics
m7.ctrl <- trainControl(method = "cv", number = 5)
m7.cv <- train(totDiff ~ site + sex + age + viewcat + setting + viewenc,   
                     data = sesame,                        
                     trControl = m7.ctrl,              
                     method = "lm",                      
                     na.action = na.pass)
m7.cv

AIC(lin.mod7)

lin.mod7.full <- lm(totDiff ~ (site + sex + age + viewcat + setting + viewenc)^2, data = sesame)
AIC(lin.mod7.full)

```


```{r}

# df1 <- data.frame(Response = c("bodyDiff", "letDiff", "formDiff", "numbDiff", "relatDiff", "clasfDiff", "totDiff"), Training-MSE = c(23.201, 80.703, 13.172), CV-MSE = c(25.361, 87.703, 14.938))
# table <- kable(df1, caption = "MSE", booktabs=T)
# kable_styling(table, bootstrap_options = "striped", full_width = F, latex_options = "HOLD_position")

```

Should I look for interactions?
Is LASSO necessary here?

## Q.2 Classification Question: Can we use the pre-test scores and other demographic variables to predict which region the children came from?

```{r checking-correlation-between-preTestVar}
# "viewcat", "setting", "viewenc",
pca.features <- c("age", "prebody", "prelet","preform", "prenumb", "prerelat", "preclasf", "peabody")

pca.data <- sesame[, pca.features]

round(cor(pca.data),2)
```

```{r}
ggplot(data=sesame, aes(x=prenumb, y=prelet, color=site))+
  geom_point()
ggplot(data=sesame, aes(x=prenumb, y=prerelat, color=site))+
  geom_point()
ggplot(data=sesame, aes(x=preform, y=preclasf, color=site))+
  geom_point()
ggplot(data=sesame, aes(x=preclasf, y=prerelat, color=site))+
  geom_point()
```



### SVM

```{r test-train-split}
set.seed(3241)

n <- nrow(sesame)
train.index <- sample(1:n, size = floor(0.7*n), replace=FALSE)
train.data <- sesame.sd[train.index,]
test.data <- sesame.sd[-train.index,]

train.data %>%
  count(site)
```

```{r svm-fitting}
# Response: site (categorical)
set.seed(315)
costs <- c(0.001, 0.01, 0.1, 1, 5, 10, 100)
gammas <- c(0.1, 0.5, 1, 2, 3, 4)

linear.tune <- tune(svm, site~female+ male + sd_age+sd_pBod+sd_plet+sd_pform + sd_pnumb+sd_prelat+sd_pclasf+sd_peabody, 
                    data=train.data, kernel="linear",
                    ranges=list(cost=costs))

radial.tune <- tune(svm, site~female + male + sd_age+sd_pBod+sd_plet+sd_pform + sd_pnumb+sd_prelat+sd_pclasf+sd_peabody, 
                    data=train.data, kernel="radial",
                    ranges=list(cost=costs, 
                                gamma=gammas))
#radial.tune <- tune(svm, site~sex+age+prebody+prelet+preform+prenumb+prerelat+preclasf, 
#                    data=train.data, kernel="radial",
#                    ranges=list(cost=costs, 
#                                gamma=gammas))
```

```{r}
linear.conMatrix <- table(true=test.data[, "site"],
                          pred=predict(linear.tune$best.model, newdata=test.data))

radial.conMatrix <- table(true=test.data[, "site"],
                          pred=predict(radial.tune$best.model, newdata=test.data))

confusionMatrix(linear.conMatrix)
confusionMatrix(radial.conMatrix)
```
Radial kernel improves prediction on class 1. 

RBF slightly improved after standardizing? (it seems slightly more likely to predict
on class 1. ) thought, simpler models still retain the same performance (arguably better)
sd_age+sd_pBod+sd_plet. But we are still not getting any prediction on class 4 & 5. 


```{r}
# trying to do more EDA to see if anything explains why the data is not linearly separable
boxplot(prebody~site, data=sesame)
boxplot(prelet~site, data=sesame)
boxplot(preform~site, data=sesame)
boxplot(prenumb~site, data=sesame)
boxplot(prerelat~site, data=sesame)
boxplot(preclasf~site, data=sesame)
boxplot(peabody~site, data=sesame)
```


### Trees

```{r selecting-features-trees}
set.seed(3215)
#tree.data <- sesame %>%
#  select(site, sex, age, viewcat, setting, viewenc, prebody, prelet, preform, 
#         prenumb, prerelat, preclasf)

n <- nrow(sesame)
train.index <- sample(1:n, size = floor(0.7*n), replace=FALSE)
#train.tree <- tree.data[train.index,]
#test.tree <- tree.data[-train.index,]
# "viewcat", "setting", "viewenc",

# ,"prebody", "prelet","preform", "prenumb", "prerelat", "preclasf", "postbody", "postlet", "postform", #"postnumb", "postrelat", "postclasf", "peabody"
                   
                   

tree.features <- c("site", "age", "viewcat", "setting", "viewenc")

tree.data <- sesame[, tree.features]
train.data <- tree.data[train.index,]
test.data <- tree.data[-train.index,]
```

```{r fitting-randomForest}
rf.tree<- randomForest(site~., data=tree.data, subset=train.index,
                       mtry=4, importance=TRUE)

importance(rf.tree)

rf.pred <- predict(rf.tree, newdata=test.data)

tree.conMatrix <- table(true=test.data[,"site"],
                         pred=rf.pred)
confusionMatrix(tree.conMatrix)
```
0.42 -- 0.5139 (but not including the test scores.)
around 0.45-0.48, when including the pretest scores.

As seen in the table above, there is a notable discrepancy in the number of observations that lay in classes 4 and 5 for the variable ``site``. More specifically, in the training data, there are just 25 observations with a value of 4 for the variable ``site`` and just 13 observations with a value of 5 for the variable ``site``. In other words, there are less disadvantaged rural children and disadvantaged Spanish speaking children. 

Consequently, when we initially ran our random forest model, our model was performing worse for test observations that take on the values 4 or 5 for the variable ``site``.

To remedy this problem, we decided to use Synthetic Minority Oversampling Technique (SMOTE).

```{r}

train.data$age <- as.numeric(train.data$age)
train.data$viewcat <- as.numeric(train.data$viewcat)
train.data$setting <- as.numeric(train.data$setting)
train.data$viewenc <- as.factor(train.data$viewenc)

test.data$age <- as.numeric(test.data$age)
test.data$viewcat <- as.numeric(test.data$viewcat)
test.data$setting <- as.numeric(test.data$setting)
test.data$viewenc <- as.factor(test.data$viewenc)

balanced.train.data <- SmoteClassif(site ~ ., train.data, k = 5, repl = FALSE, dist = "HEOM")
  # k --> represents the number of nearest neighbors (5) used to generate new examples of the minority class
  # repl = FALSE --> cannot have repetition of examples when performing under-sampling by selecting among the majority class(es) examples

balanced.train.data %>%
  count(site)

```

```{r re-fitting-randomForest}

rf.tree<- randomForest(site~., data=balanced.train.data,
                       mtry=4, importance=TRUE)

importance(rf.tree)

rf.pred <- predict(rf.tree, newdata=test.data)

tree.conMatrix <- table(true=test.data[,"site"],
                         pred=rf.pred)
confusionMatrix(tree.conMatrix)

```

```{r fitting-boosting}

set.seed(3215)

# ,"prebody", "prelet","preform", "prenumb", "prerelat", "preclasf", "postbody", "postlet", "postform", #"postnumb", "postrelat", "postclasf", "peabody"
                   
                   

features <- c("site", "age", "viewcat", "setting", "viewenc","prebody", "prelet","preform", "prenumb", "prerelat", "preclasf", "postbody", "postlet", "postform", "postnumb", "postrelat", "postclasf", "peabody")

tree.2 <- sesame[, features]
train.2 <- tree.2[train.index,]
test.2 <- tree.2[-train.index,]

boost.tree <- gbm(site ~., data=train.2,
                  distribution="multinomial", n.trees=5000,
                  interaction.depth=1)

#y.boost <- table(true=test.2[,"site"],
#                 pred=predict(boost.tree, newdata=test.2))

boost.conMatrix <- table(true=test.2$site,
                         pred=predict(boost.tree, newdata=test.2))
confusionMatrix(boost.conMatrix)

```



### Questions for OH:
## anything else needed in EDA?
## Both linear and radial kernels never output predictions for 4 & 5?
## polynomial kernel? Which variables to give polynomial terms
## use PCA to perform feature selection?
## feature selections for SVM in general? 

## how to interpret the confusion matrix tables for SVM & Trees
## How to interpret the imporatnce variance for multiclass classification
## interpretations about the dataset, using the bad performance of the classifiers


